<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard • VIT Parking Demo</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header class="header container">
  <div class="brand">
    <div class="logo">VP</div>
    <div>
      <div class="title">VIT Parking Dashboard</div>
      <div class="kv">ESP32‑CAM • TinyML • Firebase</div>
      <div class="kv">
        Logged in as: <strong id="roleBadge"></strong>
      </div>
    </div>
  </div>

  <nav class="nav">
    <a href="index.html">Dashboard</a>
    <a href="about.html">About</a>
    <a href="login.html" id="logout">Logout</a>
  </nav>
</header>

<main class="container">

  <!-- SYSTEM STATUS -->
  <section class="system-panel card">
    <div class="system-left">
      <div>
        <div style="font-weight:800">System status</div>
        <div class="kv">Realtime Firebase feed</div>
      </div>

      <div id="statusBadge" class="status-badge">
        <span id="statusDot" class="status-dot"></span>
        <span id="statusText" style="font-weight:700;margin-left:6px">ONLINE</span>
      </div>
    </div>
  </section>

  <!-- SINGLE SLOT -->
  <section class="grid">
    <div class="slot card">
      <div class="meta">
        <h4>Slot 1 — Entrance</h4>
        <div id="slot1" class="pill vacant">Waiting for data…</div>
      </div>

      <div style="height:10px"></div>
      <div class="small">
        Last update: <strong id="slot1Time">--</strong>
      </div>

      <!-- ADMIN ONLY -->
      <div class="admin-only" style="margin-top:12px;">
        <button class="btn" id="markVacant">Mark VACANT</button>
        <button class="btn ghost" id="markFull">Mark FULL</button>
      </div>
    </div>
  </section>

  <!-- LOG -->
  <section class="card">
    <div style="font-weight:800">Activity Log</div>
    <div class="kv">Live updates from Firebase</div>
    <div style="height:10px"></div>
    <div id="logArea" class="log"></div>
  </section>

</main>

<footer class="site-footer">
  Contact: neel.1251030298@vit.edu • © 2025 VIT Smart Parking Demo
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* ================= AUTH ================= */
if (localStorage.getItem("isLoggedIn") !== "true") {
  window.location.href = "login.html";
}

const USER_ROLE = localStorage.getItem("userRole");
const USER_EMAIL = localStorage.getItem("userEmail");

document.getElementById("roleBadge").textContent =
  USER_ROLE === "admin" ? "ADMIN" : "VIEWER";

if (USER_ROLE !== "admin") {
  document.querySelectorAll(".admin-only").forEach(el => {
    el.style.display = "none";
  });
}

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCpWOqKcUI5kDRqF3yQAKpr0PXMiDIOQT4",
  authDomain: "smart-parking-fb76f.firebaseapp.com",
  databaseURL: "https://smart-parking-fb76f-default-rtdb.firebaseio.com",
  projectId: "smart-parking-fb76f",
  storageBucket: "smart-parking-fb76f.appspot.com",
  messagingSenderId: "29983685068",
  appId: "1:29983685068:web:05c37f8c3e98e6fea90569"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const slotRef = ref(db, "parking/slot1/status");

/* ================= DOM ================= */
const slotEl = document.getElementById("slot1");
const timeEl = document.getElementById("slot1Time");
const logEl = document.getElementById("logArea");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");

function log(msg) {
  logEl.textContent =
    `[${new Date().toLocaleTimeString()}] ${msg}\n` + logEl.textContent;
}

/* ================= LISTEN ================= */
onValue(slotRef, snapshot => {
  const status = snapshot.val();
  if (!status) return;

  const empty = status === "empty";
  slotEl.textContent = empty ? "VACANT" : "FULL";
  slotEl.className = "pill " + (empty ? "vacant" : "full");
  timeEl.textContent = new Date().toLocaleString();

  statusDot.style.background = "var(--success)";
  statusText.textContent = "ONLINE";

  log(`Slot → ${slotEl.textContent}`);
});

/* ================= ADMIN WRITE ================= */
document.getElementById("markVacant")?.addEventListener("click", () => {
  if (USER_ROLE === "admin") set(slotRef, "empty");
});

document.getElementById("markFull")?.addEventListener("click", () => {
  if (USER_ROLE === "admin") set(slotRef, "two_wheeler");
});

/* ================= LOGOUT ================= */
document.getElementById("logout").addEventListener("click", () => {
  localStorage.clear();
});
</script>

</body>
</html>

